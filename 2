-- โหลด UI Library
local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/xHeptc/Kavo-UI-Library/main/source.lua"))()
local Window = Library.CreateLib("GUPRO", "DarkTheme")
local Tab = Window:NewTab("AutoFarm")
local Section = Tab:NewSection("CombatOpen")

-- Services
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer

local marineIsland = game:GetService("Workspace").Playability.Enemys["Marine Island"]
local ToolsEvent = game:GetService("ReplicatedStorage").BetweenSides.Remotes.Events.ToolsEvent

local attackDistance = 5
local tweenHeight = 2

local autoFarmEnabled = false
local autoFarmThread

local character = nil
local hrp = nil
local humanoid = nil

-- ฟังก์ชันรีเซ็ตตัวละครเมื่อเกิดใหม่
local function setupCharacter(char)
    character = char
    hrp = character:WaitForChild("HumanoidRootPart")
    humanoid = character:WaitForChild("Humanoid")
end

-- เริ่มต้นตัวละครปัจจุบัน
setupCharacter(player.Character or player.CharacterAdded:Wait())

-- ฟังก์ชัน Tween แบบมือโปร ปรับความสูงตาม tweenHeight และหมุนก้มหน้าแบบลื่นไหล
local currentTween = nil
local function tweenTo(pos)
    if not hrp then return end

    local targetPos = Vector3.new(pos.X, pos.Y + tweenHeight, pos.Z)

    -- หาตำแหน่งหมุนหันหน้าไปเป้าหมาย
    local lookAt = CFrame.new(hrp.Position, pos)
    local tiltAngle = math.rad(-60)
    local rx, ry, rz = lookAt:ToEulerAnglesYXZ()
    local finalCFrame = CFrame.new(targetPos) * CFrame.Angles(tiltAngle, ry, rz)

    -- หยุด Tween เก่าถ้ามี
    if currentTween then
        currentTween:Cancel()
        currentTween = nil
    end

    local distance = (hrp.Position - targetPos).Magnitude
    local speed = 50
    if distance > 100 then speed = 100 end

    local tweenInfo = TweenInfo.new(distance / speed, Enum.EasingStyle.Linear)

    currentTween = TweenService:Create(hrp, tweenInfo, {CFrame = finalCFrame})
    currentTween:Play()
    currentTween.Completed:Wait()
end

-- ฟังก์ชันโจมตียิง RemoteEvent
local function attackTarget()
    if ToolsEvent and ToolsEvent.FireServer then
        ToolsEvent:FireServer("Effects", 1)
    end
end

-- ฟังก์ชันรอจนมอนสเตอร์ตาย ทีละตัว
local function waitUntilDead(mob)
    local hum = mob:FindFirstChildOfClass("Humanoid")
    while hum and hum.Health > 0 and autoFarmEnabled do
        if (hrp.Position - mob.HumanoidRootPart.Position).Magnitude > attackDistance then
            tweenTo(mob.HumanoidRootPart.Position)
        end
        attackTarget()
        task.wait(0.3)
    end
end

-- ฟังก์ชัน Auto Farm หลัก
local function autoFarm()
    while autoFarmEnabled do
        if not character or not hrp or not humanoid or humanoid.Health <= 0 then
            -- รอให้เกิดใหม่
            repeat
                task.wait(0.5)
            until character and hrp and humanoid and humanoid.Health > 0
        end

        for _, mobName in ipairs({"Recruit61","Recruit62","Recruit63","Recruit64","Recruit65","Recruit66"}) do
            if not autoFarmEnabled then break end
            local mob = marineIsland:FindFirstChild(mobName)
            if mob and mob:FindFirstChild("HumanoidRootPart") and mob:FindFirstChildOfClass("Humanoid") then
                local hum = mob:FindFirstChildOfClass("Humanoid")
                if hum.Health > 0 then
                    waitUntilDead(mob)
                end
            end
        end
        task.wait(0.5)
    end
end

-- เริ่ม / หยุด Auto Farm
local function setAutoFarm(state)
    autoFarmEnabled = state
    if state then
        autoFarmThread = task.spawn(autoFarm)
    else
        if currentTween then
            currentTween:Cancel()
            currentTween = nil
        end
    end
end

-- จับ event เปลี่ยนตัวละครใหม่
player.CharacterAdded:Connect(function(char)
    setupCharacter(char)
    if autoFarmEnabled then
        -- รีสตาร์ท Auto Farm ถ้ามันเปิดอยู่
        setAutoFarm(false)
        task.wait(0.2)
        setAutoFarm(true)
    end
end)

-- UI Toggle เปิด-ปิด Auto Farm
Section:NewToggle("Toggle Auto Farm", "Start/Stop Auto Farm Recruit61-66", function(state)
    setAutoFarm(state)
end)

-- UI Slider ปรับความสูง Tween 1-10 stud
Section:NewSlider("Adjust Tween Height", "ปรับความสูงเวลาขึ้นตี (Stud)", 10, 1, function(value)
    tweenHeight = value
    print("[Auto Farm] Tween Height set to:", tweenHeight)
end)

-- ป้องกัน Humanoid กระโดดด้วยการปิด JumpPower ชั่วคราว (แค่ตอน Auto Farm)
RunService.Heartbeat:Connect(function()
    if humanoid and autoFarmEnabled then
        humanoid.JumpPower = 0
        humanoid.UseJumpPower = true
    elseif humanoid then
        humanoid.JumpPower = 50 -- คืนค่าเริ่มต้น Roblox
        humanoid.UseJumpPower = true
    end
end)

print("[Auto Farm] Pro Script Loaded.")
